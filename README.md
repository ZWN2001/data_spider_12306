
温馨提示：仅供学习，请理智使用

# Python爬12306余票

项目地址：https://github.com/ZWN2001/data_spider_12306

数据库课设使用的爬虫

半成品，需要根据`todo`自己改改

`main.py`查的是学生票

`main2.py`查的是成人票

爬虫教程在 [here](https://zwn-2001-github-io.vercel.app/2022/07/05/Python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%B0%8F%E9%BB%91%E5%B1%8B/)

## 一些问题的解答

### 为什么要分成人与学生

如果你进行请求就会发现默认（成人票）只能请求到近几个月的数据。

而学生票则可以请求到更多。

&nbsp;

### 成人与学生爬虫的区别

区别主要在请求的`url`与使用的`cookie`上。

`url`会使用`purpose_codes`参数进行区分。

`cookie`上，学生票要比成人票的`cookie`严格很多，无法直接通过`selenium`获取，只能手动填写、更新。

成人票使用了`selenium`的无头浏览器，默认使用了谷歌浏览器。

&nbsp;

### `cookie`的结构

两种票的`cookie`都是由两部分组成的，一部分是固定的`cookie`数据，通过多次相应头的`set_Cookie`设置的，从浏览器中可以获取，学生票`cookie`还会对其中的一些属性进行修改，并且会添加加密过的`fo`属性。

另一部分是请求的行程信息，其中起点与终点的值为`站名,站编码`的形式并用`escape`编码，这一点在代码中有清晰的体现。

&nbsp;

### 其他可能存疑的技术点

协程、`aiohttp`、`asyncio`、`request`，在教程里都有写

&nbsp;

## 可能的其他问题

### 关于连接池

使用了两种方案，更推荐单连接池但是容易被12306发现并ban掉。

&nbsp;

### 关于被ban

使用时很可能因为各种原因被ban，报错的网页很明显，是后端发现了爬虫，但是不影响cookie的使用，（仅使用`aiohttp`时会有这种问题），解决方案是在循环时添加一些`sleep`以避免被当成是服务拒绝攻击。
